name: Rejected Quote by Payee FSP
use_case: Merchant-Initiated Merchant Payment
behavior: positive
description: |
  The Service Provider wants to test if he is capable of receiving a transaction from a different wallet provider that he has an account.
  In this case, we simulate the scenario when the Payer would like to buy goods or services from a Service Provider (the Payee), but each of them uses different wallet providers.
  This flow shows the necessary steps for this transaction simulating a rejected quote by the payee FSP.
precondition: |
  Service Provider has GSMA Mobile Money API Implemented.
  Service Provider is capable of handled async calls.
  Payee and Payer MMOs exist in Mojaloop as Participants.
  Payee and Payer exist in Mojaloop as Parties.
  Amount should be the value "51.03".
  Debit party should be identified by account identifier "msisdn" with the value "+33555123456".
  Credit party should be identified by account identifier "msisdn" with the value "+33555789123".
components:
  - Service Provider
  - Mobile Money Operator 1
  - Mobile Money Operator 2
test_steps:
  - path: /transactions
    method: POST
    source: Service Provider
    target: Mobile Money Operator 1
    api_scheme: MM v1.1.2
    trigger:
      amount: '51.03'
    test_request_scripts:
      - name: Header has the Url Callback
        rules:
          headers.x-callback-url.*: 'required|regex:/.*/'
      - name: Debit and Credit party is present and is a Valid Party in the network
        rules:
          body.debitParty.*.key: 'in:msisdn'
          body.debitParty.*.value: 'in:+33555123456'
          body.creditParty.*.key: 'in:msisdn'
          body.creditParty.*.value: 'in:+33555789123'
      - name: Amount and currency are specified correctly
        rules:
          body.amount: 'in:51.03'
          body.currency: 'required|regex:/^[A-Z]{3}/'
      - name: Transaction is a Merchant Payment
        rules:
          body.type: 'in:merchantpay'
    test_response_scripts:
      - name: Transaction was successfully accepted
        rules:
          status: 'in:202'
      - name: Server Correlation Id is specified correctly
        rules:
          body.serverCorrelationId: 'required|regex:/^[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}$/'
      - name: Status is specified correctly
        rules:
          body.status: 'in:pending'
      - name: Notification Method is specified correctly
        rules:
          body.notificationMethod: 'in:callback'
    request:
      method: POST
      uri: /transactions
      headers:
        accept: 'application/json'
        content-type: 'application/json'
        x-callback-url: 'http://example.com/example'
        x-date: '2020-04-07T10:28:44.466Z'
      body:
        amount: '51.03'
        currency: 'USD'
        type: 'merchantpay'
        debitParty:
          - key: 'msisdn'
            value: "+33555123456"
        creditParty:
          - key: 'msisdn'
            value: '+33555789123'
    response:
      status: 202
      headers:
        content-type: 'application/json'
        x-date: '2020-04-07T10:28:44.466Z'
      body:
        serverCorrelationId: 'be77f48f-2433-4bfa-8cdd-aaf058a400de'
        status: 'pending'
        notificationMethod: 'callback'
  - path: /transactionRequests
    method: POST
    source: Mobile Money Operator 1
    target: Mojaloop
    api_scheme: Mojaloop v1.0
    trigger:
      amount:
        amount: '51.03'
    test_request_scripts:
      - name: Transaction Type is a Merchant Payment
        rules:
          body.transactionType.scenario: 'in:PAYMENT'
          body.transactionType.initiator: 'in:PAYEE'
          body.transactionType.initiatorType: 'in:BUSINESS'
      - name: Transaction Request Id created
        rules:
          body.transactionRequestId: 'required|regex:/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/'
      - name: Debit and Credit party is present and is a Valid Party in the network
        rules:
          body.payer.partyIdInfo.partyIdType: 'in:MSISDN'
          body.payer.partyIdInfo.partyIdentifier: 'in:+33555123456'
          body.payee.partyIdInfo.partyIdType: 'in:MSISDN'
          body.payee.partyIdInfo.partyIdentifier: 'in:+33555789123'
      - name: Amount and currency are specified correctly
        rules:
          body.amount.amount: 'in:51.03'
          body.amount.currency: 'required|regex:/^[A-Z]{3}/'
    test_response_scripts:
      - name: Transaction was successfully accepted
        rules:
          status: 'in:202'
    request:
      method: POST
      uri: /transactionsRequests
      headers:
        content-type: 'application/vnd.interoperability.transactionRequests+json;version=1.0'
        date: 'Wed, 07 Apr 2020 10:28:45 GMT'
        fspiop-source: 'payeefsp'
        fspiop-destination: 'payerfsp'
      body:
        transactionRequestId: '950b88b3-cbcc-4f5d-92e7-46666529a7b6'
        payee:
          partIdInfo:
            partyIdType: 'MSISDN'
            partyIdentifier: "+33555789123"
        payer:
          partyIdType: 'MSISDN'
          partyIdentifier: "+33555123456"
        amount:
          amount: '51.03'
          currency: 'USD'
        type: 'merchantpay'
        transactionType:
          scenario: 'PAYMENT'
          initiator: 'PAYEE'
          initiatorType: 'BUSINESS'
    response:
      status: 202
  - path: /transactionRequests
    method: POST
    source: Mojaloop
    target: Mobile Money Operator 2
    api_scheme: Mojaloop v1.0
    trigger:
      amount:
        amount: '51.03'
    test_request_scripts:
      - name: Transaction Type is a Merchant Payment
        rules:
          body.transactionType.scenario: 'in:PAYMENT'
          body.transactionType.initiator: 'in:PAYEE'
          body.transactionType.initiatorType: 'in:BUSINESS'
      - name: Transaction Request Id created
        rules:
          body.transactionRequestId: 'required|regex:/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/'
      - name: Debit and Credit party is present and is a Valid Party in the network
        rules:
          body.payer.partyIdInfo.partyIdType: 'in:MSISDN'
          body.payer.partyIdInfo.partyIdentifier: 'in:+33555123456'
          body.payee.partyIdInfo.partyIdType: 'in:MSISDN'
          body.payee.partyIdInfo.partyIdentifier: 'in:+33555789123'
      - name: Amount and currency are specified correctly
        rules:
          body.amount.amount: 'in:51.03'
          body.amount.currency: 'required|regex:/^[A-Z]{3}/'
    test_response_scripts:
      - name: Transaction was successfully accepted
        rules:
          status: 'in:202'
    request:
      method: POST
      uri: /transactionsRequests
      headers:
        content-type: 'application/vnd.interoperability.transactionRequests+json;version=1.0'
        date: 'Wed, 07 Apr 2020 10:28:45 GMT'
        fspiop-source: 'payeefsp'
        fspiop-destination: 'payerfsp'
      body:
        transactionRequestId: '950b88b3-cbcc-4f5d-92e7-46666529a7b6'
        payee:
          partIdInfo:
            partyIdType: 'MSISDN'
            partyIdentifier: "+33555789123"
        payer:
          partyIdType: 'MSISDN'
          partyIdentifier: "+33555123456"
        amount:
          amount: '51.03'
          currency: 'USD'
        type: 'merchantpay'
        transactionType:
          scenario: 'PAYMENT'
          initiator: 'PAYEE'
          initiatorType: 'BUSINESS'
    response:
      status: 202
  - path: /transactionRequests/{ID}
    method: PUT
    source: Mobile Money Operator 2
    target: Mojaloop
    api_scheme: Mojaloop v1.0
    trigger:
      transactionRequestState: 'RECEIVED'
    test_request_scripts:
      - name: ID is Valid
        rules:
          path: 'required|regex:/transactionRequests\/[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i'
          body.transactionId: 'required|regex:/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/'
      - name: Transaction Status is Received
        rules:
          body.transactionRequestState: 'in:RECEIVED'
    test_response_scripts:
      - name: Transaction was successfully accepted
        rules:
          status: 'in:200'
    request:
      method: PUT
      uri: /transactionsRequests/950b88b3-cbcc-4f5d-92e7-46666529a7b6
      headers:
        content-type: 'application/vnd.interoperability.transactionRequests+json;version=1.0'
        date: 'Wed, 07 Apr 2020 10:28:45 GMT'
        fspiop-source: 'payerfsp'
        fspiop-destination: 'payeefsp'
      body:
        transactionRequestState: 'RECEIVED'
    response:
      status: 200
  - path: /transactionRequests/{ID}
    method: PUT
    source: Mojaloop
    target: Mobile Money Operator 1
    api_scheme: Mojaloop v1.0
    trigger:
      transactionRequestState: 'RECEIVED'
    test_request_scripts:
      - name: ID is Valid
        rules:
          path: 'required|regex:/transactionRequests\/[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i'
          body.transactionId: 'required|regex:/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/'
      - name: Transaction Status is Received
        rules:
          body.transactionRequestState: 'in:RECEIVED'
    test_response_scripts:
      - name: Transaction was successfully accepted
        rules:
          status: 'in:200'
    request:
      method: PUT
      uri: /transactionsRequests/950b88b3-cbcc-4f5d-92e7-46666529a7b6
      headers:
        content-type: 'application/vnd.interoperability.transactionRequests+json;version=1.0'
        date: 'Wed, 07 Apr 2020 10:28:45 GMT'
        fspiop-source: 'payerfsp'
        fspiop-destination: 'payeefsp'
      body:
        transactionRequestState: 'RECEIVED'
    response:
      status: 200
  - path: /quotes
    method: POST
    source: Mobile Money Operator 2
    target: Mojaloop
    api_scheme: Mojaloop v1.0
    trigger:
      amount:
        amount: '51.03'
    test_request_scripts:
      - name: Mandatory IDs is present
        rules:
          body.quoteId: 'required|regex:/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/'
          body.transactionId: 'required|regex:/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/'
      - name: Transaction Type is a Merchant Payment
        rules:
          body.transactionType.scenario: 'in:PAYMENT'
          body.transactionType.initiator: 'in:PAYEE'
          body.transactionType.initiatorType: 'in:BUSINESS'
      - name: Payer wants to send money to Payee
        rules:
          body.amountType: 'in:SEND'
      - name: Debit and Credit party is present and is a Valid Party in the network
        rules:
          body.payer.partyIdInfo.partyIdType: 'in:MSISDN'
          body.payer.partyIdInfo.partyIdentifier: 'in:+33555123456'
          body.payee.partyIdInfo.partyIdType: 'in:MSISDN'
          body.payee.partyIdInfo.partyIdentifier: 'in:+33555789123'
      - name: Amount and currency are specified correctly
        rules:
          body.amount.amount: 'in:51.03'
          body.amount.currency: 'required|regex:/^[A-Z]{3}/'
    test_response_scripts:
      - name: Transaction was successfully accepted
        rules:
          status: 'in:202'
    request:
      method: POST
      uri: /quotes
      headers:
        content-type: 'application/vnd.interoperability.quotes+json;version=1.0'
        date: 'Wed, 07 Apr 2020 10:28:45 GMT'
        fspiop-source: 'payerfsp'
        fspiop-destination: 'payeefsp'
      body:
        quoteId: 'ba2a764f-41d0-4b47-a774-dfe51012b04a'
        transactionId: 'ea1ae93f-d5b7-4f36-96c6-7fb164e1f23e'
        payee:
          partIdInfo:
            partyIdType: 'MSISDN'
            partyIdentifier: "+33555789123"
        payer:
          partIdInfo:
            partyIdType: 'MSISDN'
            partyIdentifier: "+33555123456"
          personalInfo:
            complexName:
              firstName: 'Lars'
              middleName: 'Per'
              lastName: 'Bergqvist'
            dateOfBirth: '1977-07-17'
        amountType: 'SEND'
        amount:
          currency: 'USD'
          amount: '51.03'
        transactionType:
          scenario: 'PAYMENT'
          initiator: 'PAYEE'
          initiatorType: 'BUSINESS'
    response:
      status: 202
  - path: /quotes
    method: POST
    source: Mojaloop
    target: Mobile Money Operator 1
    api_scheme: Mojaloop v1.0
    trigger:
      amount:
        amount: '51.03'
    test_request_scripts:
      - name: Mandatory IDs is present
        rules:
          body.quoteId: 'required|regex:/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/'
          body.transactionId: 'required|regex:/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/'
      - name: Transaction Type is a Merchant Payment
        rules:
          body.transactionType.scenario: 'in:PAYMENT'
          body.transactionType.initiator: 'in:PAYEE'
          body.transactionType.initiatorType: 'in:BUSINESS'
      - name: Payer wants to send money to Payee
        rules:
          body.amountType: 'in:SEND'
      - name: Debit and Credit party is present and is a Valid Party in the network
        rules:
          body.payer.partyIdInfo.partyIdType: 'in:MSISDN'
          body.payer.partyIdInfo.partyIdentifier: 'in:+33555123456'
          body.payee.partyIdInfo.partyIdType: 'in:MSISDN'
          body.payee.partyIdInfo.partyIdentifier: 'in:+33555789123'
      - name: Amount and currency are specified correctly
        rules:
          body.amount.amount: 'in:51.03'
          body.amount.currency: 'required|regex:/^[A-Z]{3}/'
    test_response_scripts:
      - name: Transaction was successfully accepted
        rules:
          status: 'in:202'
    request:
      method: POST
      uri: /quotes
      headers:
        content-type: 'application/vnd.interoperability.quotes+json;version=1.0'
        date: 'Wed, 07 Apr 2020 10:28:45 GMT'
        fspiop-source: 'payerfsp'
        fspiop-destination: 'payeefsp'
      body:
        quoteId: 'ba2a764f-41d0-4b47-a774-dfe51012b04a'
        transactionId: 'ea1ae93f-d5b7-4f36-96c6-7fb164e1f23e'
        payee:
          partIdInfo:
            partyIdType: 'MSISDN'
            partyIdentifier: "+33555789123"
        payer:
          partIdInfo:
            partyIdType: 'MSISDN'
            partyIdentifier: "+33555123456"
          personalInfo:
            complexName:
              firstName: 'Lars'
              middleName: 'Per'
              lastName: 'Bergqvist'
            dateOfBirth: '1977-07-17'
        amountType: 'SEND'
        amount:
          currency: 'USD'
          amount: '51.03'
        transactionType:
          scenario: 'PAYMENT'
          initiator: 'PAYEE'
          initiatorType: 'BUSINESS'
    response:
      status: 202
  - path: /quotes/{ID}/error
    method: PUT
    source: Mobile Money Operator 1
    target: Mojaloop
    api_scheme: Mojaloop v1.0
    trigger:
      errorInformation:
        errorCode: '5103'
    test_request_scripts:
      - name: ID is Valid
        rules:
          path: 'required|regex:/quotes\/[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}\/error$/i'
      - name: Error Code is specified correctly
        rules:
          body.errorInformation.errorCode: 'in:5103'
          body.errorInformation.errorDescription: 'required|regex:/^.{1,128}$/'
    test_response_scripts:
      - name: Transaction was successfully declined
        rules:
          status: 'in:200'
    request:
      method: 'PUT'
      uri: /quotes/ba2a764f-41d0-4b47-a774-dfe51012b04a
      headers:
        content-type: 'application/vnd.interoperability.quotes+json;version=1.0'
        date: 'Wed, 07 Apr 2020 10:28:45 GMT'
        fspiop-source: 'payeefsp'
        fspiop-destination: 'payerfsp'
      body:
        transferAmount:
          currency: 'USD'
          amount: '51.03'
        expiration: '2020-04-13T12:50:15.273Z'
        ilpPacket: 'AQAAAAAAAADIEHByaXZhdGUucGF5ZWVmc3CCAiB7InRyYW5zYWN0aW9uSWQiOiIyZGY3NzRlMi1mMWRiLTRmZjctYTQ5NS0yZGRkMzdhZjdjMmMiLCJxdW90ZUlkIjoiMDNhNjA1NTAtNmYyZi00NTU2LThlMDQtMDcwM2UzOWI4N2ZmIiwicGF5ZWUiOnsicGFydHlJZEluZm8iOnsicGFydHlJZFR5cGUiOiJNU0lTRE4iLCJwYXJ0eUlkZW50aWZpZXIiOiIyNzcxMzgwMzkxMyIsImZzcElkIjoicGF5ZWVmc3AifSwicGVyc29uYWxJbmZvIjp7ImNvbXBsZXhOYW1lIjp7fX19LCJwYXllciI6eyJwYXJ0eUlkSW5mbyI6eyJwYXJ0eUlkVHlwZSI6Ik1TSVNETiIsInBhcnR5SWRlbnRpZmllciI6IjI3NzEzODAzOTExIiwiZnNwSWQiOiJwYXllcmZzcCJ9LCJwZXJzb25hbEluZm8iOnsiY29tcGxleE5hbWUiOnt9fX0sImFtb3VudCI6eyJjdXJyZW5jeSI6IlVTRCIsImFtb3VudCI6IjIwMCJ9LCJ0cmFuc2FjdGlvblR5cGUiOnsic2NlbmFyaW8iOiJERVBPU0lUIiwic3ViU2NlbmFyaW8iOiJERVBPU0lUIiwiaW5pdGlhdG9yIjoiUEFZRVIiLCJpbml0aWF0b3JUeXBlIjoiQ09OU1VNRVIiLCJyZWZ1bmRJbmZvIjp7fX19'
        condition: 'HOr22-H3AfTDHrSkPjJtVPRdKouuMkDXTR4ejlQa8Ks'
    response:
      status: 200
  - path: /quotes/{ID}/error
    method: PUT
    source: Mojaloop
    target: Mobile Money Operator 2
    api_scheme: Mojaloop v1.0
    trigger:
      errorInformation:
        errorCode: '5103'
    test_request_scripts:
      - name: ID is Valid
        rules:
          path: 'required|regex:/quotes\/[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}\/error$/i'
      - name: Error Code is specified correctly
        rules:
          body.errorInformation.errorCode: 'in:5103'
          body.errorInformation.errorDescription: 'required|regex:/^.{1,128}$/'
    test_response_scripts:
      - name: Transaction was successfully declined
        rules:
          status: 'in:200'
    request:
      method: 'PUT'
      uri: /quotes/ba2a764f-41d0-4b47-a774-dfe51012b04a
      headers:
        content-type: 'application/vnd.interoperability.quotes+json;version=1.0'
        date: 'Wed, 07 Apr 2020 10:28:45 GMT'
        fspiop-source: 'payeefsp'
        fspiop-destination: 'payerfsp'
      body:
        transferAmount:
          currency: 'USD'
          amount: '51.03'
        expiration: '2020-04-13T12:50:15.273Z'
        ilpPacket: 'AQAAAAAAAADIEHByaXZhdGUucGF5ZWVmc3CCAiB7InRyYW5zYWN0aW9uSWQiOiIyZGY3NzRlMi1mMWRiLTRmZjctYTQ5NS0yZGRkMzdhZjdjMmMiLCJxdW90ZUlkIjoiMDNhNjA1NTAtNmYyZi00NTU2LThlMDQtMDcwM2UzOWI4N2ZmIiwicGF5ZWUiOnsicGFydHlJZEluZm8iOnsicGFydHlJZFR5cGUiOiJNU0lTRE4iLCJwYXJ0eUlkZW50aWZpZXIiOiIyNzcxMzgwMzkxMyIsImZzcElkIjoicGF5ZWVmc3AifSwicGVyc29uYWxJbmZvIjp7ImNvbXBsZXhOYW1lIjp7fX19LCJwYXllciI6eyJwYXJ0eUlkSW5mbyI6eyJwYXJ0eUlkVHlwZSI6Ik1TSVNETiIsInBhcnR5SWRlbnRpZmllciI6IjI3NzEzODAzOTExIiwiZnNwSWQiOiJwYXllcmZzcCJ9LCJwZXJzb25hbEluZm8iOnsiY29tcGxleE5hbWUiOnt9fX0sImFtb3VudCI6eyJjdXJyZW5jeSI6IlVTRCIsImFtb3VudCI6IjIwMCJ9LCJ0cmFuc2FjdGlvblR5cGUiOnsic2NlbmFyaW8iOiJERVBPU0lUIiwic3ViU2NlbmFyaW8iOiJERVBPU0lUIiwiaW5pdGlhdG9yIjoiUEFZRVIiLCJpbml0aWF0b3JUeXBlIjoiQ09OU1VNRVIiLCJyZWZ1bmRJbmZvIjp7fX19'
        condition: 'HOr22-H3AfTDHrSkPjJtVPRdKouuMkDXTR4ejlQa8Ks'
    response:
      status: 200
  - path: '{X-Callback-URL}'
    method: PUT
    source: Mobile Money Operator 1
    target: Service Provider
    trigger:
       errorCode: 'genericError'
       errorCategory: 'businessRule'
    test_request_scripts:
    - name: Error category is valid
      rules:
        body.errorCategory: 'in:businessRule'
    - name: Error code is valid
      rules:
        body.errorCode: 'in:genericError'
    test_response_scripts:
    - name: Transaction was successfully declined
      rules:
        status: 'in:204'
    request:
      method: 'PUT'
      uri: 'http://example.com/example'
      headers:
        content-type: 'application/json'
        x-date: '2020-04-07T10:28:44.466Z'
      body:
        errorCategory: 'businessRule'
        errorCode: 'genericError'
    response:
      status: 204
